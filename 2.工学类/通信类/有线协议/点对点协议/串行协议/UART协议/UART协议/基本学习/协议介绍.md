# **1. 协议基础**

## **1.1.**    **协议简介**

   UART是“Universal Asynchronous Receiver/Transmitter”，通用异步收发器的缩写。在19世纪60年代，为了解决计算机和电传打字机通信，Bell发明了 UART协议，将并行输入信号转换成串行输出信号。因为UART简单实用的特性，其已经成为一种使用非常广泛的通讯协议。我们日常接触到的串口，RS232，RS485等总线，内部使用的基本都是 UART协议 。

   为了更好的理解和分析协议与总线的关系，我们通常把一个完整的通讯规范划分成物理层，协议层以及应用层。物理层只定义真实的信号特性（比如电压，电流，驱动能力等），以及电信号与逻辑信号0和1的对应关系；协议层不关心底层的0和1具体怎么实现，只规定逻辑信号的协议规范以及通讯过程（例如起始，数据以及结束等）；应用层不关心数据是怎么获取的，只定义数据表示的意义，以及如何实现具体的业务逻辑。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/uart-layers.png)

                                                               图 1‑1 通讯协议的分层实现

     最简单的UART协议应用，通常物理层只需要两根传输线，一根用于发送，一根用于接收，从而实现全双工通讯。对于单向传输，也可以只使用一根传输线。此类应用最典型的实例就是单片机的RX/TX端口互相连接，从而实现基于TTL电平的UART通讯。对于不同的传输距离以及可靠性的要求，替换不同的物理层实现既可以得到我们常见的RS232、RS485等通讯总线。

## **1.2.**   **不同的物理层实现**

     由于UART协议层的输入是逻辑0/1信号，而逻辑0/1信号在物理层可以通过不同的电平标准来区分。针对不同的通讯需求，便可以使用不同的物理层实现。例如简单的板内通讯，或者常见的设备调试场景，使用简单的LVTTL/TTL电平即可在两个设备间进行UART协议通讯。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E4%B8%8D%E5%90%8C%E7%89%A9%E7%90%86%E5%B1%82%E5%AE%9E%E7%8E%B0.png)

                                                                 图 1‑2 不同的物理层电平标准

      通用的串口则使用的是RS232电平，可以增加传输距离，并且抵抗一定程度的信号干扰。付出的成本则是在物理层需要对应的电平转换芯片来实现，发送端需要将内部的高低电平信号转换成电压更高的+/-电压信号，接收端需要将+/-电压信号转换成内部的高低电平信号。

在工业通讯的场景下，为了进一步提高传输距离，以及增强信号的可靠性，一般会采用RS485的电平标准。在发送端将普通的高低电平信号转换成一对差分信号，在接收端将差分信号再转换成普通的高低电平信号。另外，RS485允许总线上连接多达128收发器，而TTL或者RS232则是点对点的连接。

### 1.2.1. 基于TTL的UART通讯

     基于TTL的UART通讯，是UART协议应用最简单的使用场景。即直接把数字I/O输出的高低电平作为实际的物理信号进行传输。在物理连接上，只需要设备共地，通过一根信号线即可完成单向的设备通讯。如果需要双向全双工，使用两根信号线即可。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9F%BA%E4%BA%8ETTL%E7%9A%84UART%E9%80%9A%E8%AE%AF.png)

                                                               图 1‑3 基于TTL的UART通讯

     为了对比不同物理层实现的差别，我们可以观察发送相同数据时，不同物理层的实际信号有何不同。这里以发送字符‘D‘为例，通过璞石示波器，直接观察TTL实现传输的信号（探头接地端连接设备共地端，探头信号端连接上图蓝色信号线），可以获得如图 1‑4所示的信号波形。从波形可以看出，当没有数据传输时，UART信号会一直保持在高电平（具体信号幅度由I/O的供电电压决定），数据传输时信号发生跳变，传输完成后信号重新回到空闲的高电平状态。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/image4.png)

                                                               图 1‑4 TTL的UART信号波形

### 1.2.2. 基于RS232的UART通讯

      为了增强驱动能力，以增加传输距离和可靠性，RS232总线采用了双极性电压信号来进行物理传输。信号在发送/接收之前，通过电平转换芯片实现内部信号和总线信号的互相转换。连接方式和TTL电平完全相同，整个物理层只是多了一层电平转换。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/rs232-1.png)

                                                          图 1‑5 基于RS232的UART通讯

同样以发送字符‘D‘为例，璞石示波器的探头连接到信号端，可以采集到如图 1‑6所示的实际波形。可以看出，RS232波形在空闲时为负电压，当有数据传输时，信号开始在正负电压之间跳变，传输完成后重新回到空闲的负电压状态。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/image6.png)

                                                        图 1‑6 RS232的UART波形

### 1.2.3. 基于RS485的UART通讯

      RS485为复杂的工业环境而设计，和其它UART协议的物理层相比，RS485总线最大的特点就是使用了差分信号传输。信号在发送之前，通过RS485的收发器把单端信号转换成差分信号，再发送到总线上进行传输；同样在接收之前，总线上的差分信号通过收发器的转换变成单端信号再送给UART控制器进行接收。在RS485总线上，如果希望进行全双工的双向通讯，需要两对差分信号线（即4根信号线）。如果只进行半双工的双向通讯，则仅需要一对差分信号即可。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/rs485%E7%9A%84UART%E9%80%9A%E8%AE%AF.png)

                                                    图 1‑7 基于RS485的UART通讯

      还是以发送字符‘D‘为例，使用璞石示波器2个通道的探头（共参考地），分别连接到其中一对差分信号的A/B端，可以采集到如图 1‑8所示的实际波形。可以看出，A/B端的波形为互补关系。A端波形为正向逻辑（空闲时为正电压），B端波形为反向逻辑（空闲时为负电压）。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/image8.png)

                                                          图 1‑8 RS485的UART波形

# **2.协议规范**

## **2.1.** UART帧结构

      在上一节的介绍中，我们通过璞石示波器观察了实际的UART波形，那么这个波形到底是怎么被准确的识别成字符‘D‘，而不是其它内容的呢？这就涉及到UART协议帧结构的定义。如图 2‑1所示：

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/UART%E5%8D%8F%E8%AE%AE%E5%B8%A7%E7%BB%93%E6%9E%84.png)

                                                              图 2‑1 UART协议帧结构

   当两个设备需要通过UART协议进行通讯时，它们需要同时约定好以下内容：

- 每一位信号的时间长度T（波特率 = 1/T）
- 帧结构中每一项的具体位数
- 是否有校验位，以及校验位的机制（奇/偶/..）

有了这些约定，接收设备只需要等待起始位的到来，再对之后的波形进行固定间隔的采样即可获得传输的具体信息。以字符‘D‘的波形为例，其解析过程如图 2‑2所示：

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/uart%E6%B3%A2%E5%BD%A2%E5%88%86%E6%9E%90.png)

                                                                     图 2‑2 UART波形分析

### 2.1.1.波特率

      波特率是UART协议，或者说所有异步串行协议，非常重要的一个概念，即单位时间内（1秒）可表示的bit位个数，或者也可以表述为bit位宽的倒数。例如一个波特率为115200的UART波形表示1秒可容纳115200个bit位，也就是说每一位bit数据占大约8.68uS的时长。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E6%B3%A2%E7%89%B9%E7%8E%87%E5%AE%9A%E4%B9%89.png)

                                                                  图 2‑3 波特率的定义

       UART等异步串行协议，为了简化信号物理连接，降低通讯成本，一般只有一根信号线，无法同时传输数据和时钟信号。收/发设备为了正确解析波形就需要在相同的波特率设置下。而相同的波形使用不同的波特率获取的信息可能会完全不同。对于接收设备来讲，只有起始位可以作为一帧数据的同步点，其它数据都是通过波特率来确定具体的取样位置。

还是以字符‘D’的波形为例，如图 2‑4所示，如果用错误的波特率接收，就可能会得到完全错误的数据信息。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E6%B3%A2%E7%89%B9%E7%8E%87%E9%94%99%E8%AF%AF.png)

                                                                图 2‑4 波特率错误

### 2.1.2.空闲位

      设备之间不传输数据时以持续的高电平表示空闲。空闲位持续时间越长，两个数据帧间隔也越长，单位时间传输的数据就越少。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9B%BE2-5%E7%A9%BA%E9%97%B2%E4%BD%8D.png)

                                                                  图 2‑5 空闲位

### 2.1.3.起始位

UART接收端会一直检测信号线上的电平变化，开始传输数据时，发送端将信号线从高电平拉到低电平结束空闲状态，并保持一个bit位的时长。接收器检测到高低电平转换时，开始接收信号。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9B%BE2-6%E8%B5%B7%E5%A7%8B%E4%BD%8D.png)

                                                                          图 2‑6 起始位

### 2.1.4.数据位

      数据位包含传输的实际数据，如果使用了奇偶校验，那么数据位长为5~8 bits，如果没有使用奇偶校验，则位长为5~9 bits。在一般情况下，数据位为 8 bits，数据首先从最低有效位开始发送，高位在后。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9B%BE2-7%E6%95%B0%E6%8D%AE%E4%BD%8D.png)

                                                                       图 2‑7 数据位

### 2.1.5.校验位

    校验位可以用来提高传输的可靠性。如果信号在传输过程中因为干扰而导致某些位置的电平产生错误，通过计算接收的数据和校验位是否匹配即可判断数据是否有传输错误，从而给应用层提供有效信息来决定接受/丢弃对应的数据。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9B%BE2-8%E6%A0%A1%E9%AA%8C%E4%BD%8D.png)

                                                                     图 2‑8 校验位

### 2.1.6.停止位

      停止位表示一帧数据的结束，实际信号是一段时间的高电平。停止位的时间长短可以设置为1、1.5或者2bits的停止位。大部分情况使用1bit的停止位。

因为UART是一个异步协议，每一帧的开头可以用跳变沿来同步，但是停止位只能通过波特率来计算相对位置，如果在停止位的位置识别到一个低电平，则会产生帧错误。在通讯过程中，为了减少波特率的误差导致的问题，可以设置不同的停止位长度来适配。

![](http://dreamsourcelab.cn/wp-content/uploads/2022/08/%E5%9B%BE2-9%E5%81%9C%E6%AD%A2%E4%BD%8D.png)

                                                                       图 2‑9 停止位


## 2.2 UART工作模式
### 2.2.1 双线全双工模式

异步模式是 UART 最基本也是最常用的工作模式。在这种模式下，通信双方不需要共享一个时钟信号，而是通过数据格式中的起始位和停止位来同步数据。异步通信的特点包括：

- **全双工通信**：数据可以在两个方向上同时传输，即发送和接收可以同时进行。
- **无共享时钟**：发送方和接收方不需要同步时钟信号，这使得异步通信在不同设备间更容易实现。
- **数据帧结构**：每个数据帧通常包括起始位、数据位（通常是8位）、可选的校验位和停止位。



### 2.2.2 单线半双工模式
单线半双工模式是一种特殊的 UART 通信模式，它使用单根线进行数据传输，但在同一时间内只能进行发送或接收操作。这种模式的特点包括：

- **单线通信**：减少了所需的物理连接数量，但牺牲了全双工通信的能力。
- **半双工通信**：数据传输是单向的，同一时间只能发送或接收数据。这要求通信双方在发送和接收之间进行切换。
- **通信效率**：由于需要在发送和接收之间切换，这种模式的通信效率通常低于全双工模式。
- **应用场景**：适用于对成本和物理空间有限制，但对通信速度要求不高的场景。



### 2.2.3 多处理器通信模式

多处理器通信模式允许多个处理器或微控制器通过 UART 接口进行通信。这种模式的特点包括：

- **主从架构**：系统中有一个主处理器和多个从处理器。主处理器负责控制通信流程，而从处理器则响应主处理器的命令。
- **地址识别**：每个从处理器都有一个唯一的地址，主处理器通过发送特定的地址来选择与哪个从处理器通信。
- **多设备通信**：允许多个设备共享同一通信线路，但在同一时间内只能有一个设备进行数据传输。
- **应用场景**：适用于需要多个处理器协同工作的系统，如嵌入式系统、汽车电子和工业控制系统。



# 3. 协议特点









