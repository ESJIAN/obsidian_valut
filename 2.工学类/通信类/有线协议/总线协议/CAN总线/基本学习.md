本系列是在同公司硬件设计、验证的同事1、在完成了CANFD[硬件接口](https://so.csdn.net/so/search?q=%E7%A1%AC%E4%BB%B6%E6%8E%A5%E5%8F%A3&spm=1001.2101.3001.7020)IP开发 2、熟悉ISO-11898系列、ISO16845、CAN2.0协议、CANFD协议等以及大量学习资料 3、深入研究其他家CANFD IP（NXP、BOSCH）4、独立开发了对应底层驱动 5、通过CANoe和周立功CAN分析仪完成前述各协议要求的场景 6、以及对autosar底层接口适配后，基本上对CAN协议有了深入的理解。将过程中整理了一些文档分享出来，希望能给新入门和从业多年的相关工程师提供一点点帮助。  
主要包含CAN2.0及CANFD协议，后面对CAN2.0及CANFD的不同点做些说明。

- 可作为入门CAN协议
- 另外也有深入硬件的理解，从业多年软件工程师也可以学习一二
- 亦可作为后续查阅使用，常看常新嘛。

[CAN（-FD）协议介绍—— 深入浅出理解CAN协议（一）](https://blog.csdn.net/weixin_43083491/article/details/142327517?spm=1001.2014.3001.5501)  
[CAN_FD和CAN2.0的不同点——深入浅出理解CAN协议（二）](https://blog.csdn.net/weixin_43083491/article/details/142330379?spm=1001.2014.3001.5502)  
[CAN error情况及处理机制——深入浅出理解CAN协议（三）](https://blog.csdn.net/weixin_43083491/article/details/142331882?spm=1001.2014.3001.5502)  
[CAN协议一致性测试——深入浅出理解CAN协议（四）](https://blog.csdn.net/weixin_43083491/article/details/142493236?spm=1001.2014.3001.5502)

## 0、缩略词

前期浏览下常用CAN协议缩写，后面方便查阅。

|ABBR|英文全拼|中文释义|
|---|---|---|
|CAN|Controller Area Network|控制器局域网|
|CAN_2.0A|CAN standard mode|CAN标准模式|
|CAN_2.0B|CAN extended mode|CAN扩展模式|
|CAN_FD|CAN with flexible data-rate|带有灵活数据速率的CAN|
|ECU|Electronic Control Unit|电子控制单元|
|SOF|Start of Frame|帧起始|
|ID|Identifier|标识符|
|SRR|Substitute Remote Request|替代远程请求|
|IDE|Identifier Extension|标识符扩展|
|EDL|EXTENDED DATA LENGTH|Canfd，区分can和canfd帧|
|BRS|BIT RATE SWITCH|Canfd，指示canfd是否变速|
|ESI|ERROR STATE INDICATOR|Canfd，指示发送canfd的错误状态|
|DLC|Data Length Code|数据长度码|
|RTR|Remote Transmission Request|远程传输请求|
|CRC|Cyclic Redundancy Check|循环冗余校验|
|EOF|End of Frame|帧结束|
|SS|Synchronization Segment|同步段|
|TSEG1|Time Segment before Sample Point|采样点前的时间段|
|TSEG2|Time Segment after Sample Point|采样点后的时间段|
|SJW|Resynchronization Jump Width|重同步跳转宽度|

## 1、can总线特点

### 1.1 多主控制

1. 在总线空闲时，所有的单元都可开始发送消息（多主控制）。
2. 最先访问总线的单元可获得发送权（**CSMA/CA** 方式）。
3. 多个单元同时开始发送时，发送高优先级 ID 消息的单元可获得发送权。

没错CSMA/CA就是早期[互联网](https://edu.csdn.net/cloud/pm_summit?utm_source=blogglc)载波监听多点接入 / 碰撞避免 协议；基本特点是：1、数据发送前 , 都要先进行监听 ; 2、信道空闲后 , 才能接入 ；这里不深入介绍，因为CAN只是简单使用该协议的这两个机制，其他并未使用，对该协议感兴趣的可以简单搜索了解下

### 1.2 消息的发送

在 CAN 协议中，所有的消息都以固定的格式发送。总线空闲时，所有与总线相连的单元都可以开始发送新消息。两个以上的单元同时开始发送消息时，根据标识符（Identifier 以下称为 ID）决定优先级。ID 并不是表示发送的目的地址，而是表示访问总线的消息的优先级。两个以上的单元同时开始发送消息时，对各消息 ID 的每个位进行**逐个仲裁**比较。仲裁获胜（被判定为优先级最高）的单元可继续发送消息，仲裁失败的单元则立刻停止发送而进行接收工作。

### 1.3 系统的柔软性

与总线相连的单元没有类似于“地址”的信息。因此在总线上增加单元时，连接在总线上的其它单元的软硬件及应用层都不需要改变。

### 1.4 通信速度

根据整个网络的规模，可设定适合的通信速度。  
在同一网络中，所有单元必须设定成统一的通信速度。即使有一个单元的通信速度与其它的不一样，此单元  
也会输出错误信号，妨碍整个网络的通信。不同网络间则可以有不同的通信速度。

### 1.5 远程数据请求

可通过发送“遥控帧” 请求其他单元发送数据。

### 1.6 错误检测功能·错误通知功能·错误恢复功能

所有的单元都可以检测错误（错误检测功能）。  
检测出错误的单元会立即同时通知其他所有单元（错误通知功能）。  
正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送  
此消息直到成功发送为止（错误恢复功能）。

### 1.7 故障封闭

CAN 可以判断出错误的类型是总线上暂时的数据错误（如外部噪声等）还是持续的数据错误（如单元内部故障、驱动器故障、断线等）。由此功能，当总线上发生持续数据错误时，可将引起此故障的单元从总线上隔离出去。

### 1.8 连接

CAN 总线是可同时连接多个单元的总线。可连接的单元总数理论上是没有限制的。但实际上可连接的单元数受总线上的时间延迟及电气负载的限制。降低通信速度，可连接的单元数增加；提高通信速度，则可连接的单元数减少。

由于CAN总线采用CSMA/CA的通信机制，所以在空闲时，可能会出现多个can节点同时向总线发送消息，所以会逐位仲裁；即：从仲裁段的第一位开始进行仲裁。连续输出显性电平最多的单元可继续发送。

## 2、can bus信号

### 2.1 差分信号

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5bacb42a06fe491d9bb3f326025fb44f.png)  
总线上的电平有显性电平和隐性电平两种。总线上执行逻辑上的线“与”时，显性电平的逻辑值为“0”，隐性电平为“1”。“显性”具有“优先”的意味，只要有一个单元输出显性电平，总线上即为显性电平。并且，“隐性”具有“包容”的意味，只有所有的单元都输出隐性电平，总线上才为隐性电平。（显性电平比隐性电平更强。）  
参考：  
[https://e2e.ti.com/blogs_/b/analogwire/posts/can-bus-arbitration-to-yell-and-back](https://e2e.ti.com/blogs_/b/analogwire/posts/can-bus-arbitration-to-yell-and-back)

### 2.2 位填充

位填充是为防止突发错误而设定的功能。当同样的电平持续 5 位时则添加一个位的反型数据。

#### 2.2.1 发送单元的工作

在发送数据帧和遥控帧时，SOF～CRC 段间的数据，相同电平如果持续 5 位，在下一个位（第 6 个位）则 要插入 1 位与前 5 位反型的电平。

#### 2.2.2 接收单元的工作

在接收数据帧和遥控帧时，SOF～CRC 段间的数据，相同电平如果持续 5 位，需要删除下一个位（第 6 个 位）再接收。如果这个第 6 个位的电平与前 5 位相同，将被视为错误并发送错误帧。

## 3、帧种类

can的帧类型有：数据帧 遥控帧 错误帧 过载帧 帧间隔；在canfd中删除了遥控帧，但是实际上使用过的canfd依然可以正常收发遥控帧。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/510bc3050ff84a3cbfd9f0e0e39d972f.png)

### 3.1 数据帧

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8f0082a793044c99b51080fff5ccd78c.png)

#### 3.1.1 帧起始

1 个位的显性位。表示数据帧开始的段。

#### 3.1.2 仲裁段

- 表示数据的优先级的段。标准格式和扩展格式在此的构成有所不同。
- 标准格式仲裁段包括：id+rtr
- 扩展格式仲裁段包括：id+srr+ide+id_ext+rtr
- 根据逐位仲裁的规则，报文优先级：数据帧 > 远程帧（同id）、标准数据帧>扩展数据帧（id28-18相同）、扩展数据帧 > 扩展远程帧（同id）

Note：

- 标准格式的ID有11个位。从ID28到ID18被依次发送。禁止高7位都为隐性。（禁止设定：ID=1111111XXXX）
- 扩展格式的ID有29个位。基本ID从ID28到ID18，扩展ID由ID17到ID0 表示。基本ID和标准格式的ID相同。禁止高7位都为隐性。（禁止设定：基本ID=1111111XXXX）

虽然有这种要求，但是实际物理层是可以正常收发上述ID的报文的。

#### 3.1.3 控制段

表示数据的字节数及保留位的段（这里和canfd帧有所不同）

1. 保留位（r0、r1）  
    **保留位必须全部以显性电平发送**。但接收方可以接收显性、隐性及其任意组合的电平。
2. 数据长度码（DLC）  
    数据的字节数必须为 0～8 字节。但接收方对 DLC = 9～15 的情况并不视为错误

#### 3.1.4 数据段

数据的内容，可发送 0～8 个字节的数据。数据段可包含 0～8 个字节的数据。从 MSB（最高位）开始输出。（fd帧为 0-64 bytes）

#### 3.1.5 CRC 段

检查帧的传输错误的段。CRC 段是检查帧传输错误的帧。由 15 个位的 CRC 顺序*1 和 1 个位的 CRC 界定符（用于分隔的位）构成。

Note:

1. CRC 顺序  
    CRC 顺序是根据多项式生成的 CRC 值，CRC 的计算范围包括帧起始、仲裁段、控制段、数据段。接收方以同样的算法计算 CRC 值并进行比较，不一致时会通报错误。
2. CANFD帧采用CRC17和CRC21

#### 3.1.6 ACK 段

表示确认正常接收的段。

1. 发送单元的ACK 段  
    发送单元在 ACK 段发送2个位的隐性位。
2. 接收单元的 ACK 段  
    接收到正确消息的单元在 ACK 槽(ACK Slot)发送显性位，通知发送单元正常接收结束。这称作“发  
    送 ACK”或者“返回 ACK”。

发送ACK 的是在既不处于总线关闭态也不处于休眠态的所有接收节点中，接收到正常消息的单元（发送单元不发送 ACK）。所谓正常消息是指不含填充错误、格式错误、CRC 错误的消息。

#### 3.1.7 帧结束

帧结束是表示该该帧的结束的段。由 7 个位的隐性位构成。

### 3.2 远程帧

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3bc0940c8cd948b0ae94e8e307390c07.png)

数据帧和遥控帧的不同

- 1、遥控帧的 RTR 位为隐性位，没有数据段。
- 2、没有数据段的数据帧和遥控帧可通过 RTR 位区别开来。
- 3、遥控帧没有数据段，数据长度码该如何表示？
- 4、遥控帧的数据长度码以所请求数据帧的数据长度码表示。
- 5、没有数据段的数据帧有何用途？  
    例如，可用于各单元的定期连接确认/应答、或仲裁段本身带有实质性信息的情况下。

### 3.3 错误帧

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ebee53291702480391f859db5ccd7b2c.png)  
用于在接收和发送消息时检测出错误通知错误的帧。错误帧由错误标志和错误界定符构成。

#### 3.3.1 错误标志

错误标志包括主动错误标志和被动错误标志两种。

- 1、主动错误标志：6 个位的显性位。
- 2、被动错误标志：6 个位的隐性位。

#### 3.3.2 错误界定符

错误界定符由 8 个位的隐性位构成。

Note：

1. 主动错误标志  
    处于主动错误状态的单元检测出错误时输出的错误标志。
2. 被动错误标志  
    处于被动错误状态的单元检测出错误时输出的错误标志。

### 3.4 过载帧

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/94fb961d7512468c9d80b0d8185593ac.png)

过载帧是用于接收单元通知其尚未完成接收准备的帧。过载帧由过载标志和过载界定符构成。

#### 3.4.1 过载标志

6 个位的显性位。  
过载标志的构成与主动错误标志的构成相同。

#### 3.4.2 过载界定符

8 个位的隐性位。  
过载界定符的构成与错误界定符的构成相同。

### 3.5 帧间隔

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/385de81f348d4b3790fba6df82a314eb.png)

帧间隔是用于分隔数据帧和遥控帧的帧。数据帧和遥控帧可通过插入帧间隔将本帧与前面的任何帧（数据帧、遥控帧、错误帧、过载帧）分开。  
**过载帧和错误帧前不能插入帧间隔。**

#### 3.5.1 间隔

3个位的隐性位。

#### 3.5.2 总线空闲

隐性电平，无长度限制（0 亦可）。  
本状态下，可视为总线空闲，要发送的单元可开始访问总线。

#### 3.5.3 延迟传送（发送暂时停止）

8个位的隐性位。  
只在处于**被动错误状态的单元刚发送一个消息后的帧间隔中包含的段**。

## 4 同步基址

CAN协议的通信方法为NRZ（Non-Return to Zero）方式。各个位的开头或者结尾都没有附加同步信号。发送单元以与位时序同步的方式开始发送数据。另外，接收单元根据总线上电平的变化进行同步并进行接收工作。但是，发送单元和接收单元存在的时钟频率误差及传输路径上的（电缆、驱动器等）相位延迟会引起同步偏差。因此接收单元通过硬件同步或者再同步的方法调整时序进行接收。

### 4.1 硬件同步

接收单元在总线空闲状态检测出帧起始时进行的同步调整。在检测出边沿的地方不考虑SJW的值而认为是 SS 段。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5b9d96d3933445f3afb6f6bc38738c71.png)

### 4.2 重同步

在接收过程中检测出总线上的电平变化时进行的同步调整。  
每当检测出边沿时，根据 SJW 值通过加长 PBS1 段，或缩短 PBS2 段，以调整同步。但如果发生了超出 SJW 值的误差时，最大调整量不能超过 SJW 值。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/13b68fcf5f79430ea8580519d1a14744.png)

### 4.3 调整同步的规则

硬件同步和重同步遵从如下规则。

- 1、1个位中只进行一次同步调整。
- 2、只有当上次采样点的总线值和边沿后的总线值不同时，该边沿才能用于调整同步。
- 3、在总线空闲且存在隐性电平到显性电平的边沿时，则一定要进行硬件同步。
- 4、在总线非空闲时检测到的隐性电平到显性电平的边沿如果满足条件（1）和（2），将进行重同步。但还要满足下面条件。
- 5、发送单元观测到自身输出的显性电平有延迟时不进行重同步。
- 6、发送单元在帧起始到仲裁段有多个单元同时发送的情况下，对延迟边沿不进行重同步。

### 4.4 实际硬件行为

实际上，同步这里不好理解，特别是对搞软件的，这里抓了下硬件时序图，就很容易理解了。

#### 4.4.1 硬件同步

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/30c27c9cba6242b49980484420cd3197.png)

- 1、接收节点的bit_time状态机在初始化后一直在ss-seg1-seg2跳转
- 2、bus上进来sof很大概率不是落在ss（异步通信）
- 3、此时sof刚好落在了seg1，所以can内部会调整bit_time状态机直接到ss  
    Note：接收节点会做一个信号同步，将can_bus打拍调整为rx_bus_monitor（后续状态机实际也是也是和该信号一致变化）

#### 4.4.2 重同步

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/67bcad8e59f04f59aee9abaeb91c42e4.png)  
为了不让can_bus误导，只拉了rx_bus_monitor，配置为：seg1 = a，seg2 = 3，sjw = 2  
1、由于时钟电平相位关系，导致本次显性电平向隐性电平变化时，落在在seg1，所以此时将发生重同步，seg1_val 变为 seg1+sjw = c;（可以看到bitref_cnt_r在seg1是从0累加到c就才跳到seg2状态）  
2、下一bit的显性电平向隐性电平变化时，落在了seg2，也会发生重同步，seg2_val 变为了seg2 - sjw = 1。（这里由于检查到电平变化以及到了seg2结束，虽然seg2_val变化了，但是cnt已经累加结束，所以实际没有减，该累计的相位差可能会到后面bit消除）





### NOTE

本节参考了很多瑞萨的手册（入门必读），许多截图也为了方便是直接截取，很多细节及难以理解之处，结合硬件真实行为给出了自己理解。



 ---
 


## 0 简介

直接来看CAN2.0和CANFD，CANFD是在链路层对CAN协议做了升级，物理层并未改变；区别从宏观上来说：帧格式、传输速度和数据长度等上有不同。

1. 帧类型上CAN2.0支持远程帧，而CANFD不支持（实际使用下来，bosch、nxp家的CANFD是可以支持远程帧收发的，这里应该是应用层做了限制不让发送远程帧）；帧格式会在下面第一节详细说明
2. 传输速度：CAN2.0最大传输速率为1Mbps；CANFD仲裁比特率最高1Mbps，数据比特率最高8Mbps
3. 传输数据长度：CAN2.0最大DLC=8 bytes；CANFD最大DLC=64 bytes

网上大部分文章都是针对这些的表象和特点在说明，都是软件使用时直接可以看到的，对大部分软件从业人员基本覆盖很全了，我将深入的介绍细节，让软件使用者也有更深的理解；另外对硬件设计也有一点参考。  
抛砖引玉，如有更多见解，评论区一起讨论。

## 1 帧格式Frame structure

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5eaf7d8a2fbd49cc96e56897419934d3.png)

1. 帧头SOF
2. 仲裁域  
    11bit ID + RTR，canfd不支持remote帧，RTR为reserved
3. 控制域  
    除了IDE、r0和dlc字段，canfd还多了EDL、BRS以及ESI

|ABBR|英文全拼|作用|
|---|---|---|
|EDL|EXTENDED DATA LENGTH|Canfd，区分can和canfd帧|
|BRS|BIT RATE SWITCH|Canfd，指示canfd是否变速|
|ESI|ERROR STATE INDICATOR|Canfd，指示发送canfd的错误状态|

4. 数据域  
    用户希望发送的数据，经典can支持一次传输0-8bytes的数据，canfd支持一次传输0-64bytes数据
5. 检查循环冗余序列（CRC）+ DEL
    - 经典can通过15bit的CRC来校验数据，DEL为delimiter，即CRC delimiter
    - canfd的crc算法为crc-17，crc-21，其中dlc>=20时，采用crc-21，dlc<20时，采用crc17
6. ack域  
    包含1bit的ack slot和1bit的ack delimiter。
7. 帧尾（EOF）  
    通过连续7bit的隐性位来表示
8. IFS  
    inter-frame space

**Note:**  
1、对于29bit的扩展帧，标准can和canfd是类似的。

## 2 CRC 计算

一般软件人员对这块不用深入，只需简单了解即可  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2c1b7042a57341f7b5e86fcd9ce3949d.png)

### 2.1. crc多项式

- CRC_15，用于经典CAN格式的所有帧。  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/3c114fc10431459faf111caa04dd6cda.png)
    
- CRC_17，用于CANFD帧，数据字段最多16字字节。  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/199d4ada1ab44b8d9082fc15bd23d5bb.png)
    
- CRC_21，用于CANFD帧且数据字段大于16的CAN帧字节。![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c6aa2953de4046d29c1fb8bc44071fa7.png)
    

### 2.2. fix stuff bit

- 在crc多项式发送时，每隔4bit插入1bit的fix stuff bit（该bit和前面bit相反）
- crc15不会插入fix stuff bit，crc-17和crc-21会按照上面原则插入
- fix stuff bit不会参与crc计算

### 2.3. stuff cnt

crc-17和crc-21的crc字段中包含stuff count字段，该字段是sof-data中包含的stuff bit模8后根据规则生成gray-code（格雷码有兴趣可以自行搜索学习下，标准格雷码参考下图）  
例如上图crc-21前面stuff bit共14个，14%8 = 6，所以gray-code为101，根据规则末尾补0  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9568ee95f3694cdaa06ae3f109d3d16c.png)

### 2.4. stuff bit

在crc-15时，sof-data中stuff bit不参与计算；而crc-17和crc-21需要参与计算

### 2.5. ISO模式和bosch模式

博世在设计协议时做了一个bosch模式；区别在于：

- bosch模式stuff count是不参与crc计算的（图示逻辑分析仪解码错误，不用在意）
- crc初始值（0x00000）和ISO模式（0x10000）不一样，  
    crc是由硬件来实现，软件不用关心那么细节，只需要收发时配置一致（见到的大部分的CANFD的硬件都支持配置bosch模式）就可以了。（下图是bosch）  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/aaed453c78ca44fdacb308e4d80cee03.png)

## 3 Ack field

Ack filed包括ACK SLOT and the ACK DELIMITER.  
在CAN FD格式中，所有节点应接受2 bit的重叠ACK位主导相位作为有效ACK，以补偿接收器之间的相位差；在CAN格式中，所有节点只能接受一个1bit的ack slot。  
这也就是说在CAN格式中如果ack delimiter为显性，则控制器会产生form err，而CANFD格式则正常。

## 4 变速bit timing

canfd是支持变速的，即在数据段支持以更快的速率传输数据；这里就涉及一个问题，就是什么时间变速，以及变速bit的处理。  
如下图：

- 变速阶段从BRS开始到CRC-delimiter结束
- BRS bit的bit timing ：Sync+seg1（N）+seg2（D）
- CRC-delimiter的bit timing：Sync+seg1（D）+seg2（N）







---




## 0、错误帧格式

错误帧由两个不同的域组成。第一个域是不同节点提供的错误标志重叠部分；第二个域是错误定界符。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1b30896d51264022a4bdc538900b6c3a.png)

- 主动错误标志：6个连续的显性位
- 被动错误标志：6个连续的隐性位
- 错误定界符：8个连续的隐性位
- 错误标志之后还有0~6个错误标志重叠部分

### 0.1 错误标志

错误标志分为主动错误标志和被动错误标志两种：

#### 0.1.1 主动错误标志

主动错误标志由6个连续的显性位组成。处于主动错误状态的节点检测到错误时会发送主动错误标志。主动错误标志会违反位填充规则和位域的固定形式，这会造成其它节点也检测到错误并发送错误标志（错误标志重叠部分形成的原因）。所有节点所发送的显性序列叠加组成错误标志重叠部分。错误标志重叠部分的长度在6-12个显性位之间。

#### 0.1.2 被动错误标志

被动错误标志由6个连续的隐性位组成，被动错误标志可能会被其他节点的显性位改写。（必须为6个连续的隐性位才能代表被动错误标志发送完成），（应当理解为节点发送了6个连续隐性位就行，而不需要关注总线上的状态有没有被其他节点改写。）

### 0.2 错误定界符

错误定界符由八个连续的隐性位组成。当发送完错误标志后，所有节点开始向总线发送一个隐性位，并检测到总线电平为隐性时，发送余下的七个隐性位。

## 1、CAN错误定义

CAN 协议定义了五种不同的方法来检测错误。其中两种是位级别错误，另外三种是报文级别的错误类型。

1. 位监控 2. 位填充 3. 帧检查 4. 应答检查 5. 循环冗余检查  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a6b7b9ab926d4554851c9f0ab83dea0a.png)  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d838483a642741f7b94ee1ea8b0cc12a.png)

### 1.1 错误介绍

### 1.1.1 位监控 BIT ERR(recessive/dominant bit err)

位错误由向总线上输出数据帧、遥控帧、错误帧、过载帧的单元和输出 ACK 的单元、输出错误的单元来  
检测。

向总线发送一个位的节点同时会监控总线，当监控到总线的位数值和发送的位数值不一致时，则鉴定为一个位错误。（SOF到EOF的位使用位错误检测）  
**例外：**

- 1）在仲裁段输出隐性电平，但检测出显性电平时，将被视为仲裁失败，而不是位错误。
- 2）在仲裁段作为填充位输出隐性电平时，但检测出显性电平时，将不视为位错误，而是填充错误。
- 3）发送单元在 ACK 段输出隐性电平，但检测到显性电平时，将被判断为其它单元的 ACK 应答，而非位错误。
- 4）输出被动错误标志（6 个位隐性位）但检测出显性电平时，将遵从错误标志的结束条件，等待检测出连续相同 6 个位的值（显性或隐性），并不视为位错误。

#### 1.1.2 位填充 (stuff err)

当一个节点已经发送了相同级别的五个连续位时，它将向输出位添加相反电平的第六位。接收方将删除这个额外的位。这样做是为了避免总线上出现过度的直流电成分；但它同时也给予了接收方检测错误的额外机会；  
如果总线上出现五个以上相同级别的连续位，会发出信号指示填充错误。  
**例外：**

- 1）**SOF到CRC序列的结束**的位使用位填充错误检测。

#### 1.1.3 循环冗余检查 (crc err)

每帧报文都包含一个多位(classic can :crc15、fdcan:crc17/crc21)的循环冗余校验和（CRC）。节点如果在报文中检测到与自己计算所得不同的CRC，将产生CRC错误。

#### 1.1.4 帧格式错误

CAN报文的一些部分具有固定的格式，也就是说，标准明确定义了何种级别和何时必须发生。（那些部分是 CRC 定界符、ACK 定界符、帧结束以及帧间隔，但是帧间隔还有一些另外的特殊错误检查规则）。如果 CAN 控制器在这些固定字段中的一个中检测到无效值，将发出帧格式错误。  
**例外：**

- 1）接收节点在**EOF的最后一位**检测到显性位，不鉴定为形式错误。
- 2）任何节点在**错误定界符**或**过载定界符**的最后一位检测到显性位，不鉴定为形式错误。
- 3）对于**CANFD帧**，ack允许两个bit的容错
- 4）canfd接收到can帧dlc为 9-15也不检测为格式错误

#### 1.1.5 应答错误(nack err)

正确接收报文的总线上的所有节点（不管这些节点是否对报文内容“感兴趣”）预期将在报文中所谓的应答时隙发送一个显性电平。发送节点在此将发送隐性电平。如果发送节点在应答时隙未检测到显性电平，会产生应答错误。

## 2、CAN错误状态

CAN节点可以区分常规错误和永久故障。有故障的发送节点将切换到总线关闭状态。总线关闭状态在逻辑上与总线断开，既不能发送也不能接收。can的发送错误状态：

- 1、active
- 2、passive
- 3、bus off  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/72630d0d30694a809c8562c82849a1f7.png)

### 2.1 主动错误状态（active ）

主动错误状态是可以正常参加总线通信的状态。**处于主动错误状态的单元检测出错误时，输出主动错误标志**。处于主动错误状态的节点能正常参与总线通信的收发，当检测到错误时将发送主动错误标志，错误标志由**6个连续的显性位组成**（这种连续的6个显性位与常规的填充位和其它帧固定格式不相同，正因为如此，硬件才容易区别）。

**Tips：**  
处于主动错误状态，说明这个节点目前是比较可靠的，出现错误的原因可能不是它本身的问题，即刚刚检测到的错误可能不仅仅只有它检测到，正因为如此，整个总线才允许它破坏正在发送中的报文。

### 2.2 被动错误状态(passive)

被动错误状态是易引起错误的状态。处于被动错误状态的单元虽能参加总线通信，但为不妨碍其它单元通信，**接收时不能积极地发送错误通知**。 处于被动错误状态的单元即使检测出错误，而其它**处于主动错误状态的单元如果没发现错误，整个总线也被认为是没有错误的**。 处于被动错误状态的单元检测出错误时，输出被动错误标志。  
如果是发送节点发出被动错误帧，刚刚被发送的报文被破坏。**错误帧发送完成后，接着的是帧间隔（3个隐性位）和“传输延时段”（8个隐性位）**，这时总线上的其他节点就可以判断总线处于空闲状态并参与总线竞争。这种机制可以让其他处于主动错误状态的节点优先使用总线。  
如果是接收节点发出被动错误帧，则不会对总线产生任何影响

**Tips：**  
处于被动错误状态，说明这个节点目前是不可靠的，出现错误的原因可能是它本身的问题，即刚刚检测到的错误可能只有它自己检测到，正因为如此，整个总线不会信任它的报告，从而只允许它发送6个连续的隐性位，这样才不会拖累其他节点。

### 2.3 总线关闭状态(bus off)

总线关闭态是不能参加总线上通信的状态。信息的接收和发送均被禁止。这些状态依靠发送错误计数和接收错误计数来管理，根据计数值决定进入何种状态。

**Tips：**  
由于存在实现方式的不同，CAN总线关闭状态存在只允许用户请求恢复和检测到128个11位连续的隐性位时自恢复两种不同的恢复形式。  
如果总线上只有一个节点，该节点发送数据帧后得不到应答，TEC最大只能计数到128，即这种情况下节点只会进入被动错误状态而不会进入总线关闭状态。

### 2.4 CAN错误计数

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f23614b3b0374f4c91261add76d70b4a.png)

## 3 CAN错误的发送

总线通信错误以向总线发送错误帧作为标志。  
节点产生**位错误、填充错误、格式错误或者NACK后，将会在当前发送位的下一位发送错误帧**；  
产生**CRC错误后，紧随ACK定界符后的位发送错误帧**。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ebe23ff91d8343829175c0e36c9d5ef8.png)  
如果节点开启重发基址，错误帧发送完成后，将在总线空闲时自动重发出之前出错的数据帧。

### 3.1 位错误发送

#### 3.1.1 总线上所有节点处于主动错误状态

- ①当一个发送节点监控到总线上的位数值与发送的位数值不一致时，检测为位错误，并发送主动错误标志（6个连续的显性位）；
- ②接收节点接收到发送节点发送的6个连续的显性位时，会检测为位填充错误，也会发送主动错误标志；（6个连续的显性位）；
- ③发送节点发送完主动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；
- ④当接收节点发送完主动错误标志后，开始向总线发送错误定界符；
- ⑤等待错误帧发送完成，总线空闲后，发送节点重新发送出错的报文；

**Note：**

- 由于发送节点发送6个连续的显性位会破坏位填充规则，触发接收节点发送主动错误标志，发送节点和接收节点的结合是形成错误标志叠加部分的原因。
- 错误标志重叠部分为6+6个显性位  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/7535a3d8b853406e89c68f8dafea75d0.png)  
    错误重叠部分为6+4个显性位  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/228bb0844623433ba79ce6100ab23832.png)

#### 3.1.2 发送节点处于被动错误状态，接收节点处于主动错误状态

- ①当发送节点监控到总线上的位数值与发送的位数值不一致时，检测为位错误，并发送被动错误标志（6个连续的隐性位）；
- ②接收节点接收到发送节点发送的6个连续的隐性位时，会检测为位填充错误，并会发送主动错误标志；
- ③发送节点发送完被动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；
- ④接收节点发送完主动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2e23da142b484dff9f2d07748e746314.png)

### 3.2 格式错误发送

#### 3.2.1 假设总线上所有节点处于主动错误状态；

当接收节点和发送节点检测到总线上的格式错误时，下一个bit向总线上发送主动错误标志；

- ①当发送节点监控到总线上固定位（CRC 定界符、ACK 定界符、帧结束以及帧间隔）和协议不一致时，检测为格式错误，并发送主动错误标志（6个连续的显性位）；
- ②当发送节点监控到总线上固定位（CRC 定界符、ACK 定界符、帧结束以及帧间隔）和协议不一致时，检测为格式错误，也会发送主动错误标志；（6个连续的显性位）；
- ③发送节点发送完被动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；
- ④接收节点发送完主动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/157165e8af7b4593bfc0404035aa5259.png)

#### 3.2.2 发送节点处于被动错误状态，接收节点处于主动错误状态

- ①当发送节点监控到总线上固定位（CRC 定界符、ACK 定界符、帧结束以及帧间隔）和协议不一致时，检测为格式错误，并发送被动错误标志（6个连续的隐性位）；
- ②当发送节点监控到总线上固定位（CRC 定界符、ACK 定界符、帧结束以及帧间隔）和协议不一致时，检测为格式错误，并发送主动错误标志（6个连续的显性位）；
- ③发送节点发送完被动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；
- ④接收节点发送完主动错误标志后，开始监控总线是否为隐性位，当总线为隐性位时，开始发送错误定界符（8个连续的隐性位）；  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5c0043c375dd49fe9a8698c3b7c5e4f8.png)

### 3.3 CRC错误发送

#### 3.3.1 所有节点都处于主动错误状态；

- ①当**接收节点检测到CRC错误**后，在ACK定界符之后，向总线发送主动错误标志；
- ②**发送节点检测到格式错误**（EOF的固定格式为7个连续的隐性位），同时向总线发送主动错误标志；

**Note：**

- 错误标志重叠部分为**6+1个显性位**  
    ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/51b9d9ee53ee4d7a94c5eb4963bce65b.png)  
    这里列举了一些错误的场景，比如：nack时，发送节点会立即发出6bit的显性位，如果接收节点发送ack被异常拉低，将会出现bit err，等；另外，所以接收节点处于passive状态时，也没做说明（实际情况下，不可能所有接收节点都进入passive）

## 4 CAN错误状态恢复

由于实现的方式不同，CAN busoff如下存在两种不同的形态：

- 1、处于总线关闭状态的节点对总线没有任何影响，不允许发送任何帧，ACK，错误帧，过载帧。是否允许接收取决于实现方式 （能进不能出）。在检测到128个11位连续的隐性位后，节点可由总线关闭状态可以恢复到主动错误状态。
- 2、处于总线关闭状态的节点不允许任何发送和接收，只有用户请求才可以恢复。  
    目前市面常用的canfd ip:NXP的flexcan、博世的canfd（st采用）、瑞萨的can，进入bus-off状态后，均不能收发，但是可以1.检测到128个11位连续的隐性位，或者 2.重新初始化can来恢复。

### 4.1 CAN BUSOFF恢复过程

节点进入总线关闭状态后，普遍采用的是 快慢恢复 的形式：

#### 4.1.1 快恢复

- 定义：  
    快恢复是节点在进入Bus Off状态后，通过缩短等待时间并尝试快速恢复通信的一种策略。快恢复策略旨在尽快让节点恢复正常工作状态，减少总线通信的中断时间。
    
- 实现方式：
    
    - 当节点进入Bus Off状态后，如果MCU（微控制单元）开启了自动恢复功能，CAN控制器会在检测到特定条件（如128次11个连续的隐性位）后尝试恢复通信。
    - 在实际应用中，通常会通过MCU对CAN控制器的恢复过程进行编程处理，控制快恢复的等待时间（如50ms）。在这个等待时间结束后，MCU会重新启动CAN控制器，尝试恢复总线通信。
- 特点：
    
    - 恢复时间短，能够迅速响应通信中断。
    - 适用于临时性的通信故障，可以快速恢复总线的正常通信。

#### 4.1.2 慢恢复

- 定义：  
    慢恢复是在快恢复多次尝试失败后，通过延长等待时间并尝试恢复通信的一种策略。慢恢复策略旨在更加谨慎地处理通信故障，防止节点在不稳定状态下快速恢复并再次引起通信问题。
    
- 实现方式：  
    当节点多次进入快恢复过程但未能成功恢复通信时（如快恢复次数达到设定的阈值，如5次），MCU会将恢复时间延长至更长的时间（如200ms），并执行慢恢复过程。  
    在慢恢复等待时间结束后，MCU会重新启动CAN控制器，尝试恢复总线通信。
    

#### 4.1.3 恢复过程

1. 快恢复模式即ECU的CAN节点进入总线关闭状态后，等待时间tBusOffQuick，然后尝试向总线发送CAN报文，如果发送成功，则恢复到主动错误状态。如果发送失败，则继续等待时间tBusOffQuick后，再次尝试发送报文。
2. 如果尝试了n次后仍然发送失败，则进入慢恢复模式。在慢恢复模式下，ECU等待时间tBusOffSlow后，尝试向总线发送CAN报文，发送成功，则恢复到主动错误状态。如果发送失败，则继续等待时间tBusOffSlow后，再次尝试向总线发送CAN报文。
3. 进入慢恢复模式后，没有尝试次数的限值。

一般主机厂释放的标准中一般会有三个参数：1）快恢复时间；2）慢恢复时间；3）快恢复转慢恢复次数。例如：快恢复时间为100ms，慢恢复时间为1000ms，快恢复转慢恢复次数为5次，即5次快恢复不成功则进入慢恢复。

在AUTOSAR中配置快慢恢复机制较为简单，可在CanSM模块中配置三个参数：

- 1）CanSMBorTimeL1：对应快恢复时间；
- 2）CanSMBorTimeL2：对应慢恢复时间；
- 3）CanSMBorCounterL1ToL2：对应快恢复转慢恢复次数。



