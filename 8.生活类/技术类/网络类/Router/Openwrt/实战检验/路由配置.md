# 一、作为旁路由接入
## **基本概念**

旁路由是一种网络配置方式，它在主路由器旁边接入一台额外的路由设备，专门负责特定的网络任务，如代理、广告过滤等。这台设备不直接连接互联网，而是通过主路由器访问网络。旁路由的工作原理是在主旁路由构成的网络架构中，分担一部分路由器的功能，从而实现网络带宽的合理分配利用，并提供更强的扩展性。

## **应用场景**

旁路由的应用场景,，以下是问GPT，回答的：

- **网络覆盖扩展**：在大面积房屋或多层建筑中，旁路由可以通过设置在家中的不同位置，形成一个覆盖更广的Wi-Fi网络，消除信号盲区。
- **提升网络性能**：通过设置旁路由，用户可以对各类设备的带宽进行详细管理，优先保障重要设备的网络速度，减少视频缓冲、游戏延迟等问题。[**网络安全**](https://cloud.tencent.com/product/ddos?from_column=20065&from=20065)**防护**：旁路由可以单独配置VPN、[入侵检测](https://cloud.tencent.com/product/cwp?from_column=20065&from=20065)系统等增强安全功能，为家庭网络提供额外的防护层。
- **访问控制与内容过滤**：旁路由可以方便地设置访问控制，限制特定设备在特定时间段内上网，或是对特定网站进行访问限制，防止家庭成员接触到不良网站。
- **游戏与流媒体优化**：旁路由可以为游戏主机、流媒体设备分配更高的优先级，确保在网络高负荷时，依然能够流畅地进行游戏或者观看高清视频。
- **实验与学习平台**：对于网络爱好者以及技术人员，旁路由提供了一个极好的实验与学习平台，用户可以在旁路由上尝试不同的操作系统、配置高级的网络功能。

不过我想说，以上功能，其实在主路由上一样可以做，比如安全防护，访问控制之类的。我很赞同Eason Yang的观点，**只有你不好动主路由，或者主路由不支持改动的情况下，才考虑使用旁路由**。否则其实旁路由我感觉没多大意义。

## **配置组网**

旁路由的组网图对应如下

![](https://developer.qcloudimg.com/http-save/yehe-1160092/629697a94227479b2c3a94157e8e8746.png)

主路由的lan口连上旁路由的lan口，将旁路由的lan地址改成和主路由一个网段，地址不一样即可。终端不管是通过有线，还是无线连接，不管是连主路由，还是旁路由，都可以。根据终端网关和dns的不一样，走的流量不一样。这里我用红色的数字圈标记了1，2，3，其中1表示主路由，2表示旁路由，3表示终端设备。根据终端设备在哪儿指定网关和dns，有如下的三种配置场景，具体怎么配置就不细说了。

**方案一：主路由开启****DHCP****，旁路由关闭DHCP（非全局）**

> 这里非全局的意思是不是所有设备都过旁路由

1. 修改旁路由的管理地址网段：确保旁路由的管理地址与主路由处于同一网段，便于管理。例如，如果主路由的IP是192.168.1.1，那么旁路由可以设置为192.168.1.x，其中x是2到254之间的一个未使用的地址。
2. 关闭IPV6和DHCP服务：在旁路由的设置中，DHCP服务应该设置为忽略此接口。
3. 防火墙设置：在防火墙设置中，确保打开了IP动态伪装功能，这可以解决一些路由器会校验数据包的IP和MAC地址的对应关系的问题。
4. 终端设置：需要使用旁路由的设备，需要手动设置设备的网关和DNS指向旁路由的IP地址。

**方案二：主路由开启DHCP，旁路由关闭DHCP（全局）**

> 全局是只所有设备都过旁路由

1. 主路由设置：将主路由的DHCP的默认网关修改为旁路由的IP，DNS[服务器](https://cloud.tencent.com/product/cvm/?from_column=20065&from=20065)也修改为旁路由的IP。
2. 旁路由设置：与方案一相同，但所有设备的网络流量都将通过旁路由。

**方案三：主路由关闭DHCP，旁路由开启DHCP（全局）**

1. 主路由设置：关闭主路由的DHCP服务，设置网关和DNS为旁路由的IP。
2. 旁路由设置：开启DHCP服务，并设置网关为主路由的IP。

注意，很多网上的指导，有这样另外在配置旁路由时，可能需要在旁路由的防火墙自定义规则中添加以下规则来解决IP地址和MAC地址对应关系的问题：

javascript

```javascript
iptables -t nat -I POSTROUTING -o 网卡名 -j MASQUERADE
```

这条规则的意思是执行SNAT功能，把数据包的源IP改成旁路由的IP，无论该数据包是否会经过插件处理。这个参考实际情况来看

## **典型案例配置说明：通过旁路由管理上网策略**

我这里用ikuai做主路由，OpenWrt做旁路由，并在OpenWrt上配置了OC猫进行策略管控。ikuai的lan口连接OpenWrt的Lan口，具体连线如下，

![](https://developer.qcloudimg.com/http-save/yehe-1160092/e43193fd8ccf77d6f2497caf004b64dd.png)

ikuai主路由，管理地址10.20.30.1

OpenWrt作为旁路由，10.20.30.2

针对以上的几种方案，分别进行说明验证：

### **默认情况下**

主路由正常下发dhpc

![](https://developer.qcloudimg.com/http-save/yehe-1160092/cf426fb731145c91bb88075cda03a1ca.png)

旁路由关闭dhcp，默认走主路由出去。终端的配置和具体表现如下：

![](https://developer.qcloudimg.com/http-save/yehe-1160092/6835ef2d1eaac714b7cf2daee12fbaf5.png)

### **方案1**

手动指定网关 Windows终端侧配置

![](https://developer.qcloudimg.com/http-save/yehe-1160092/bdcde1842aa84691d09ed7da8140419d.png)

实际上网的表现：

![](https://developer.qcloudimg.com/http-save/yehe-1160092/a810330bdf0ef5ae0f7dbf33202e6aff.png)

### **方案2**

主路由下发dhcp和dns，旁路由不参与。主路由ikuai配置：

![](https://developer.qcloudimg.com/http-save/yehe-1160092/b0fc0dd7ea1978aca48d176577118b5c.png)

旁路由OpenWrt Lan口配置

![](https://developer.qcloudimg.com/http-save/yehe-1160092/fba4b81aade88ce9a4aab5946c1d8ea3.png)

终端windows上，可以看到下发的网关和dns，以及上网情况。

![](https://developer.qcloudimg.com/http-save/yehe-1160092/7610b3eed9551314f4b6f36e17704a3f.png)

### **方案3**

主路由不参与，旁路由下发网关和dns。ikuai 上dhcp配置

![](https://developer.qcloudimg.com/http-save/yehe-1160092/543df3d3cf0025d8e3f12a4ed5addf5c.png)

旁路由OpenWrt上的配置

![](https://developer.qcloudimg.com/http-save/yehe-1160092/ee9f884419d37ec53b8bf57d484028db.png)

windows终端配置以及上网情况。

![](https://developer.qcloudimg.com/http-save/yehe-1160092/b655da5074916859e631f379488837f3.png)

## **总结**

使用旁路由，就是局域网内一个代理的作用。通过旁路由可以实现一些额外的功能，不过这个前面也说了，这些都可以在主路由去做，只有在不想改变现有网络形态的情况下，才适合用旁路由。但是实际的过程中，对网络需要有些基本的了解，什么二层、三层，网关，dns，arp等，否则可能得不偿失。 - END -



# 二、作为扩展路由
### **原理**

在桥接模式下，二级路由的LAN口与一级路由的LAN口相连，二级路由的DHCP服务被关闭，同时二级路由的LAN口IP地址设置为与一级路由同一网段。这样，二级路由实际上作为一个“透明的扩展器”，将一级路由的网络信号扩展到更远的范围，但所有网络功能（包括IP地址分配）都由一级路由完成。

---

### **实现步骤**

以下是详细的配置步骤，确保新设备接入二级路由时，IP地址由一级路由分配：

#### **1. 关闭二级路由的DHCP服务**

- 登录二级路由的管理界面。
    
- 找到“LAN设置”或“DHCP设置”选项。
    
- 确保“开启DHCP服务”选项被关闭（或选择“关闭”）。
    

#### **2. 设置二级路由的LAN口IP地址**

- 在二级路由的管理界面中，找到“LAN设置”或“网络设置”。
    
- 将二级路由的LAN口IP地址设置为与一级路由同一网段，但不能与一级路由或其他设备冲突。例如：
    
    - 一级路由的IP地址为`192.168.1.1`，子网掩码为`255.255.255.0`。
        
    - 二级路由的LAN口IP地址可以设置为`192.168.1.2`，子网掩码保持一致。
        

#### **3. 连接二级路由的LAN口**

- 使用网线将一级路由的LAN口与二级路由的LAN口连接。
    
- **注意**：不要使用二级路由的WAN口，因为WAN口通常用于连接外部网络（如ISP提供的网络），而这里我们只需要扩展内部网络。
    

#### **4. 调整无线设置（可选）**

- 如果你希望无线设备在一级路由和二级路由之间无缝漫游，可以将二级路由的无线SSID（网络名称）和密码设置为与一级路由相同。
    
- **注意**：部分路由器可能不支持无线SSID完全一致，或者需要额外的漫游优化设置。
    

#### **5. 重启二级路由**

- 保存设置后，重启二级路由以确保配置生效。
    

---

### **验证**

完成上述设置后，新设备接入二级路由时，IP地址将由一级路由的DHCP服务器分配。你可以通过以下方法验证：

1. **检查设备IP地址**：
    
    - 连接设备到二级路由的网络。
        
    - 查看设备的网络设置，确认其IP地址属于一级路由的网段（例如`192.168.1.x`）。
        
2. **检查一级路由的DHCP客户端列表**：
    
    - 登录一级路由的管理界面。
        
    - 查看“DHCP客户端列表”或“已连接设备”列表，确认新设备的IP地址已由一级路由分配。
        

---

### **注意事项**

1. **IP地址冲突**：确保二级路由的LAN口IP地址不与一级路由或其他设备冲突。
    
2. **管理访问**：二级路由的管理界面可能需要通过一级路由的网段IP访问，因此建议记录二级路由的IP地址。
    
3. **网络性能**：桥接模式下，二级路由的网络性能可能受到一级路由的限制，尤其是在高负载情况下。
    
4. **无线漫游**：如果需要无线漫游，建议选择支持Mesh功能的路由器，或者使用支持无缝漫游的路由器组合。