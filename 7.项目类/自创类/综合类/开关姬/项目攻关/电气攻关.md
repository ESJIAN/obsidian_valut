# 原理图攻关

##  **【V3原理图】2925.4.8**
### ESP07 自动下载

要实现 **CH340K** 与 **ESP-07** 的一键自动下载功能，需要合理配置 CH340K 的引脚，并结合 ESP-07 的 GPIO 引脚状态（GPIO15、GPIO0、GPIO2）来满足 UART 下载模式的要求。以下是详细的实现步骤和原理说明：

---

####  **1. ESP-07 进入 UART 下载模式的 GPIO 配置**
根据 ESP-07 的规格书[[6]]，进入 UART 下载模式需要以下 GPIO 状态：
- **GPIO15**: 低电平（接地）。
- **GPIO0**: 低电平（接地）。
- **GPIO2**: 高电平（上拉到 3.3V）。

这些配置确保 ESP-07 在复位时进入 UART 下载模式，而不是正常启动（Flash Boot 模式）。

| **GPIO 引脚** | **默认电平** | **备注**                                     |
| ----------- | -------- | ------------------------------------------ |
| GPIO15      | 低电平      | 默认接地，用于确保模块正常启动。                           |
| GPIO0       | 高电平      | 默认通过上拉电阻保持高电平；进入下载模式时需拉低。                  |
| GPIO2       | 高电平      | 默认通过上拉电阻保持高电平；必须保持高电平以进入 Flash Boot 或下载模式。 |

> **说明:** 所以只需要拉低GPIO的引脚就行了。
---

####  **2. CH340K 的关键引脚功能**
根据 CH340K 的规格书[[5]]，以下几个引脚可以用于控制 ESP-07 的 GPIO 状态和复位操作：
- **DTR#**:
  - 输出信号，由计算机应用程序控制。
  - 用于控制 MCU 的 GPIO0，将其拉低以进入 UART 下载模式。
- **RTS#**:
  - 输出信号，由计算机应用程序控制。
  - 用于触发 MCU 的复位（NRST）。
- **TNOW**:
  - 默认状态下为高电平输出，指示串口发送正在进行的状态。
  - 如果需要额外的 DTR# 功能，可以通过外接电阻将其切换为 DTR#。

---

####  **3. 实现一键自动下载的硬件连接**
以下是 CH340K 和 ESP-07 的典型连接方式：

##### **硬件连接表**
| **CH340K 引脚** | **ESP-07 引脚** | **功能说明**           |
| ------------- | ------------- | ------------------ |
| DTR#          | GPIO0         | 控制 GPIO0，拉低以进入下载模式 |
| RTS#          | RST           | 控制复位，触发模块重启        |
| TXD           | RXD0 (GPIO3)  | 数据发送               |
| RXD           | TXD0 (GPIO1)  | 数据接收               |
| GND           | GND           | 公共地线               |
| VCC           | VCC           | 电源（3.3V）           |
|               |               |                    |

##### **GPIO 配置**
- **GPIO15**:
  - 内部默认低电平，需要保持此状态（低电平）。
- **GPIO2**:
  - 内部默认高电平，需要保持此状态（高电平）。
- **GPIO0**:
  - 内部默认高电平，通过 CH340K 的 DTR# 引脚控制，拉低以进入下载模式。

---

####  **4. 一键自动下载的工作流程**
1. **初始状态**:
   - GPIO15 已接地。
   - GPIO2 已上拉到 3.3V。
   - GPIO0 默认为高电平（通过外部上拉电阻保持）。

2. **触发下载模式**:
   - 计算机端的烧录工具将 **DTR#** 拉低，使 GPIO0 变为低电平。
   - 同时，烧录工具将 **RTS#** 拉低以触发 ESP-07 的复位操作。
   - 复位后，由于 GPIO0 为低电平，ESP-07 进入 UART 下载模式。

3. **开始烧录**:
   - 烧录工具通过串口将固件写入 ESP-07 的 Flash 存储中。

4. **退出下载模式**:
   - 烧录完成后，烧录工具将 **DTR#** 和 **RTS#** 恢复为高电平。
   - 此时，GPIO0 恢复为高电平，ESP-07 返回 Flash Boot 模式。

---

####  **5. 注意事项**
- **电源电压匹配**:
  - CH340K 支持 3.3V 和 5V 电源[[5]]，但 ESP-07 的工作电压范围为 3.0V~3.6V，建议使用稳定的 3.3V 供电[[4]]。
  - 如果使用 USB 总线供电，请确保 CH340K 的输出电压与 ESP-07 匹配。

- **防倒灌保护**:
  - CH340K 内部设计了防电流倒灌机制，但仍建议在 GPIO 引脚上添加保护电路（如二极管或 MOSFET），以防止双电源情况下电流倒灌[[9]]。

- **晶振配置**:
  - 确保在烧录工具中正确设置 ESP-07 的晶振类型（如 26MHz、40MHz 等）[[9]]。

- **驱动程序**:
  - 安装 CH340K 的驱动程序（如 Windows 下的 CH341 VCP 驱动）[[5]]，确保计算机识别串口设备。

---

####  **6. 攻关总结**
通过合理利用 CH340K 的 **DTR#** 和 **RTS#** 引脚，可以实现 ESP-07 的一键自动下载功能。具体操作包括：
1. 烧录前：
	1. 使用 CH340K 的 DTR# 直接控制 GPIO0，将其从默认的高电平拉低
	2. 使用 CH340K 的 RTS# 直接控制 REST，将其从默认的高电平拉低，触发复位，且由于前面 GPIO0 为低电平，直接进入串口下载模式
2. 烧录中：
	1. RXD<-->TXD0 ；TXD<-->RXD0 进行固件下载
3. 烧录后：
	1. 使用 CH340K 的 RTS# 控制复位操作[[6]]。

这种设计简化了手动操作，提高了开发效率。


### ESP07 舵机电流采样
#### **1. 硬件设计**

##### **（1）电流采样电路**

- **采样电阻（分流电阻）** ：
    
    - 选择低阻值电阻（如 **0.1Ω~1Ω** ），串联在舵机供电回路中。
    - 根据欧姆定律 $V=I×R$，电阻两端的电压与电流成正比。
    - **示例** ：3.3V条件下测得舵机最大堵转电流为 $0.5A$，选择 $R=0.5Ω$，则最大压降为 $2A×0.5Ω=1V$，匹配 ESP07S ADC 的输入范围（0~1V）。

>**评判:** 由于该方案超过ESP07 ADC 默认输入引脚 0~1V 的输入电压限制，考虑到使用模拟电路转换电压测量范围的实现的困难性，以及该方案由于和舵机串联会抢夺舵机电压所以不考虑用这个方案。



---

- # 【**信号放大** 】
    - ## 优点：
	    - 采样功耗低：如 R=0.1Ω，2A 时仅 0.2V，采样电阻功耗为 0.4W
	- ## 缺点：
		- 
	- ## 实现：
		- 此处我采用了基于 SGM8198 的电压采样电路（性价比高、外围电路简单），直接获取电压量，之后通过在程序中计算出电流$I_s$
			- 测量：测得作为负载的 SG90 电机的堵转电流大概在0.5A左右（4.3V 直供电条件测得）。
			- 条件：ESP07的 ADC 是单端ADC，电压测量范围为 0~1V 范围
			- 计算：已知道$V_{OUT}=1·0.95V$（0.95为安全因子）,$I_{SMAX}\approx0.5A·1.2$（1.2 为安全因子）,$R_S=0.001Ω$。求得$R_L\approx1.58\dot3MΩ$，取实际组织为 $1.58MΩ$

![1744174018960.png](https://www.helloimg.com/i/2025/04/09/67f5fb0393044.png)
<center>图：SGM8198 典型使用框图</center>

![1744203292577.png](https://www.helloimg.com/i/2025/04/09/67f66d5dd9c6a.png)

<center>图：V3.0版本 ADC 采样原理图</center>




- 【参考教程】
	- [2023年全国电赛必备-国产电流检测芯片,圣邦微SGM8198 SGM8199 3PEAK思瑞浦TP181上海先积集成电路LT199 台湾省类比科技FP130A_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1fj411R7Xx/?spm_id_from=333.1007.top_right_bar_window_history.content.click)
	- 

##### **（2）连接到 ESP07S 的 ADC 引脚**

- **ADC 引脚** ：将放大后的电压信号连接到 ESP07S 的 **TOUT（ADC）引脚** （ESP-07 模块的 ADC 引脚）。
- **滤波电路** ：在 ADC 引脚前添加 **RC 滤波** （如 100Ω 电阻 + 0.1μF 电容），抑制高频噪声。

---

#### **2. 软件实现**

##### **（1）读取 ADC 值**

使用 ESP8266 的 ADC 驱动函数读取原始值：

```c
int adc_value = analogRead(A0); // 读取 ADC 值（0~1023）
```

##### **（2）转换为实际电流**

- **公式** ：
    
    $$I=\frac{Vadc​×Vref}{1023×R×Gain}​​$$
    - $Vadc$​：ADC 读取值（0~1023）。
    - $Vref$​：ESP07S 的 ADC 参考电压（默认 1V）。
    - $R$：采样电阻阻值。
    - $Gain$：放大电路增益（若未使用放大器则为 1）。
- **示例代码** ：
    
	```c
#define SAMPLE_RESISTOR 0.5  // 采样电阻 0.5Ω
#define ADC_REF_VOLTAGE 1.0  // ADC 参考电压 1V
#define GAIN 1               // 无放大

float read_current() {
  int adc_value = analogRead(A0);
  float voltage = (adc_value / 1023.0) * ADC_REF_VOLTAGE;
  float current = voltage / (SAMPLE_RESISTOR * GAIN);
  return current;
}
	```

---

#### **3. 注意事项**

##### **（1）电源与噪声处理**

- **独立供电** ：舵机可能引起电源波动，建议为 ESP07S 和舵机分别供电，共地连接。
- **去耦电容** ：在 ESP07S 的 VCC 和 GND 间添加 **100μF 电解电容** ，抑制电源噪声。
- **WiFi 干扰** ：ESP8266 的 WiFi 通信可能干扰 ADC，建议在代码中进行 **多次采样取平均** ：
	
	```c
	float read_average_current(int samples) {
	float sum = 0;
    for (int i = 0; i < samples; i++) {
	    sum += read_current();
	    delay(1);
	  }
	return sum / samples;
}
	```
	

##### **（2）保护电路**

- **过压保护** ：在 ADC 引脚前添加 **3.3V 稳压二极管** ，防止电压超过 1V。
- **隔离措施** ：若舵机电流较大（>1A），建议使用 **隔离放大器** 或 **霍尔电流传感器** （如 ACS712）。

---

#### **4. 校准与验证**

1. **硬件校准** ：
    - 使用万用表测量实际电流，对比 ESP07S 的读数，调整 `SAMPLE_RESISTOR` 和 `GAIN` 参数。
2. **软件校准** ：
    - 在代码中添加校准系数：
        
		```c
		#define CALIBRATION_FACTOR 1.05  // 根据实际测量调整
		float current = read_current() * CALIBRATION_FACTOR;
		```
        

---

#### **5. 完整示例代码**

```c
#define SAMPLE_RESISTOR 0.5
#define ADC_REF_VOLTAGE 1.0
#define GAIN 1
#define CALIBRATION_FACTOR 1.05

float read_current() {
  int adc_value = analogRead(A0);
  float voltage = (adc_value / 1023.0) * ADC_REF_VOLTAGE;
  return (voltage / (SAMPLE_RESISTOR * GAIN)) * CALIBRATION_FACTOR;
}

void setup() {
  Serial.begin(115200);
}

void loop() {
  float current = read_current();
  Serial.print("Current: ");
  Serial.print(current);
  Serial.println(" A");
  delay(1000);
}
```

---

#### **总结**

通过 **采样电阻 + 放大电路 + ADC 转换** ，可实现舵机电流的检测。需注意电源隔离、信号滤波和校准，以确保测量精度和稳定性。若需更高精度，可考虑使用专用电流检测芯片（如 INA219）。



# PCB 攻关
## 【V3 .0 PCB】

