
# æ•´ä½“åº“å…¼å®¹æ€§

æ•´ä½“åº“å…¼å®¹æ€§æ˜¯ä¸€ä¸ªç‰¹åˆ«éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œå› ä¸ºå¦‚æœå®‰è£…åº“çš„æ—¶å€™æ²¡æœ‰è°ƒæŸ¥è¿™ä¸ªåº“çš„ç‰ˆæœ¬å’Œç°æœ‰å®‰è£…åº“çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä»¥åŠåç»­æ‰“åŒ…æ—¶å€™çš„ä¸€ä¸ªå…¼å®¹æ€§é—®é¢˜ï¼Œå¯èƒ½åœ¨åæœŸä¼šå¸¦æ¥ååˆ†æ£˜æ‰‹çš„é—®é¢˜ï¼ˆæ— æ³•è¢«æ‰“åŒ…ç­‰ï¼‰


# å¤æ‚åº“æ‰‹åŠ¨è¿ç§»

è¦è§£å†³ PyTorch æ‰“åŒ…å¤±è´¥çš„é—®é¢˜ï¼Œ**æ‰‹åŠ¨è¿ç§» PyTorch åŠå…¶ä¾èµ–åº“** æ˜¯ä¸€ç§å¯é çš„æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„è§£å†³æ–¹æ¡ˆï¼š

### âœ… 1. **æ‰‹åŠ¨è¿ç§» PyTorch çš„åŸå› **

PyTorch ä¾èµ–å¤§é‡åŠ¨æ€åº“ï¼ˆå¦‚ CUDAã€C++ æ‰©å±•ã€MKL ç­‰ï¼‰ï¼ŒPyInstaller æœ‰æ—¶æ— æ³•æ­£ç¡®æ­£ç¡®æ”¶é›†è¿™äº›ä¾èµ–ï¼Œå¯¼è‡´æ‰“åŒ…å¤±è´¥ã€‚æ‰‹åŠ¨è¿ç§»å¯ä»¥ï¼š
- **ç¡®ä¿æ‰€æœ‰ä¾èµ–æ–‡ä»¶å®Œæ•´**
- **é¿å… PyInstaller çš„éšå¼ä¾èµ–æ”¶é›†é—®é¢˜**
- **çµæ´»æ§åˆ¶ä¾èµ–è·¯å¾„**

### âœ… 2. **æ“ä½œæ­¥éª¤**

#### ğŸ“Œ æ­¥éª¤ 1ï¼šæ‰¾åˆ° PyTorch å®‰è£…è·¯å¾„
åœ¨è™šæ‹Ÿç¯å¢ƒæˆ–å…¨å±€ç¯å¢ƒä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å– PyTorch çš„å®‰è£…è·¯å¾„ï¼š
```bash
pip show torch
````

è¾“å‡ºç¤ºä¾‹ï¼š

```plaintext
Location: c:\users\administrator\appdata\local\programs\python\python310\lib\site-packages
```

PyTorch çš„æ ¸å¿ƒæ–‡ä»¶åœ¨Â `torch/`Â ç›®å½•ä¸‹ã€‚

#### ğŸ“Œ æ­¥éª¤ 2ï¼šå¤åˆ¶ PyTorch ç›®å½•åˆ°é¡¹ç›®ä¸­

å°†Â `torch/`Â ç›®å½•å¤åˆ¶åˆ°æ‚¨çš„é¡¹ç›®ç›®å½•ä¸‹ï¼ˆå¦‚Â `src/`Â æˆ–Â `vendor/`ï¼‰ï¼š

  

plaintext

```plaintext
Canteen_Statisic/ 
â”œâ”€â”€ src/ 
â”œâ”€â”€ vendor/ 
â”‚   â””â”€â”€ torch/  # ğŸ‘ˆ å¤åˆ¶çš„ PyTorch ç›®å½•
```

#### ğŸ“Œ æ­¥éª¤ 3ï¼šåœ¨ä»£ç ä¸­åŠ¨æ€æ·»åŠ  PyTorch è·¯å¾„

åœ¨Â `main_window.py`Â ä¸­ï¼Œæ‰‹åŠ¨æ·»åŠ Â `vendor/torch`Â åˆ°Â `sys.path`ï¼Œç¡®ä¿ç¨‹åºèƒ½æ­£ç¡®å¯¼å…¥ PyTorchï¼š

```python
import sys 
import os 

# è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
current_file_path = os.path.abspath(__file__)

# è·å–é¡¹ç›®æ ¹ç›®å½•
project_root = os.path.abspath(os.path.join(current_file_path, '..', '..', '..'))

# æ·»åŠ  vendor/torch åˆ° sys.path
sys.path.insert(0, os.path.join(project_root, 'vendor', 'torch'))

# ç°åœ¨å¯ä»¥å®‰å…¨å¯¼å…¥ torch
import torch
```

#### ğŸ“Œ æ­¥éª¤ 4ï¼šæ‰“åŒ…æ—¶æ˜¾å¼åŒ…å« PyTorch çš„ä¾èµ–åº“

åœ¨Â `.spec`Â æ–‡ä»¶ä¸­ï¼Œç¡®ä¿Â `vendor/torch`Â è¢«æ­£ç¡®æ‰“åŒ…ï¼š


```python
a = Analysis(
    ['main_window.py'],
    pathex=['..'],
    binaries=[],
    datas=[
        ('../.paddleocr', 'paddleocr'),
        ('../../src', 'src'),
        ('../../vendor/torch', 'torch')  # ğŸ‘ˆ æ·»åŠ  vendor/torch åˆ°æ‰“åŒ…è·¯å¾„
    ],
    hiddenimports=[],
    ...
)
```

#### ğŸ“Œ æ­¥éª¤ 5ï¼šå¤åˆ¶ PyTorch çš„ä¾èµ– DLL æ–‡ä»¶ï¼ˆWindowsï¼‰

PyTorch ä¾èµ–å¤šä¸ª DLL æ–‡ä»¶ï¼ˆå¦‚ CUDAã€C++ è¿è¡Œæ—¶ã€MKL ç­‰ï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨å¤åˆ¶åˆ°æ‰“åŒ…ç›®å½•ä¸­ï¼š

  

1. **æ‰¾åˆ° PyTorch çš„ DLL è·¯å¾„**ï¼š
    
    - PyTorch å®‰è£…è·¯å¾„ä¸‹çš„Â `torch/lib/`Â ç›®å½•ï¼ˆå¦‚Â `C:\Users\Administrator\AppData\Local\Programs\Python\Python310\Lib\site-packages\torch\lib`ï¼‰
2. **å¤åˆ¶ DLL åˆ°æ‰“åŒ…ç›®å½•**ï¼š
    
    - å°†Â `torch/lib/`Â ä¸­çš„Â `.dll`Â æ–‡ä»¶å¤åˆ¶åˆ°Â `dist/main_window/`Â ç›®å½•ä¸‹ï¼š
    
    bash
    
    ```bash
    cp -r C:\Users\Administrator\AppData\Local\Programs\Python\Python310\Lib\site-packages\torch\lib\* dist/main_window/
    ```
    
      
    

#### ğŸ“Œ æ­¥éª¤ 6ï¼šæ‰“åŒ…å¹¶éªŒè¯

æ¸…ç†ç¼“å­˜åé‡æ–°æ‰“åŒ…ï¼š


```bash
rm -rf build dist 
pyinstaller --clean main_window.spec
```

è¿è¡Œæ‰“åŒ…åçš„ç¨‹åºï¼š

```bash
dist/main_window/main_window.exe
```

ç¡®ä¿Â `torch`Â èƒ½è¢«æ­£ç¡®å¯¼å…¥ï¼Œå¹¶éªŒè¯æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œã€‚

### âœ… 3.Â **å®Œæ•´ç¤ºä¾‹**

#### ğŸ“ ç›®å½•ç»“æ„ï¼ˆæ‰“åŒ…åï¼‰

```plaintext
dist/main_window/ 
â”œâ”€â”€ main_window.exe 
â”œâ”€â”€ torch/              # ğŸ‘ˆ æ‰‹åŠ¨è¿ç§»çš„ PyTorch æ¨¡å— 
â”‚   â”œâ”€â”€ __init__.py 
â”‚   â”œâ”€â”€ nn/ 
â”‚   â”œâ”€â”€ utils/ 
â”‚   â””â”€â”€ ... 
â”œâ”€â”€ torch.dll 
â”œâ”€â”€ torch_cpu.dll 
â”œâ”€â”€ cudnn64_8.dll 
â””â”€â”€ ...
```

#### ğŸ“„ main_window.py ä¸­çš„è·¯å¾„è®¾ç½®

```python
import sys 
import os 

# è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
current_file_path = os.path.abspath(__file__)

# è·å–é¡¹ç›®æ ¹ç›®å½•
project_root = os.path.abspath(os.path.join(current_file_path, '..', '..', '..'))

# æ·»åŠ  vendor/torch åˆ° sys.path
sys.path.insert(0, os.path.join(project_root, 'vendor', 'torch'))

# å¯¼å…¥ PyTorch
import torch
```

#### ğŸ“„ main_window.spec æ–‡ä»¶é…ç½®

```python
a = Analysis(
    ['main_window.py'],
    pathex=['..'],
    binaries=[],
    datas=[
        ('../.paddleocr', 'paddleocr'),
        ('../../src', 'src'),
        ('../../vendor/torch', 'torch')  # ğŸ‘ˆ æ·»åŠ  vendor/torch åˆ°æ‰“åŒ…è·¯å¾„
    ],
    hiddenimports=[],
    ...
)
```

### âœ… 4.Â **è¡¥å……å»ºè®®**

#### ğŸ“Œ æ–¹æ³•ä¸€ï¼šä½¿ç”¨Â `--add-binary`Â æ˜¾å¼æ·»åŠ  DLL æ–‡ä»¶

å¦‚æœæ‚¨ä¸æƒ³æ‰‹åŠ¨å¤åˆ¶ DLL æ–‡ä»¶ï¼Œå¯ä»¥åœ¨Â `.spec`Â æ–‡ä»¶ä¸­ä½¿ç”¨Â `--add-binary`Â æ˜¾å¼æ·»åŠ ï¼š

```bash
pyinstaller main_window.spec \
  --add-binary "C:\Users\Administrator\AppData\Local\Programs\Python\Python310\Lib\site-packages\torch\lib\torch.dll;." \
  --add-binary "C:\Users\Administrator\AppData\Local\Programs\Python\Python310\Lib\site-packages\torch\lib\torch_cpu.dll;."
```

#### ğŸ“Œ æ–¹æ³•äºŒï¼šä½¿ç”¨è™šæ‹Ÿç¯å¢ƒéš”ç¦»ä¾èµ–

1. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**ï¼š
	
	
    ```bash
    python -m venv venv 
    venv\Scripts\activate 
    pip install torch
    ```
    
      
    
2. **æ‰“åŒ…æ—¶æŒ‡å®šè™šæ‹Ÿç¯å¢ƒè·¯å¾„**ï¼š
    
    
    ```bash
    pyinstaller --clean main_window.spec --paths venv\Lib\site-packages
    ```
    
      
    

### âœ… 5.Â **æ³¨æ„äº‹é¡¹**

|é—®é¢˜|è§£å†³æ–¹æ³•|
|---|---|
|**PyTorch ä¾èµ–ç¼ºå¤±**|ç¡®ä¿æ‰€æœ‰Â `.dll`ã€`.pyd`Â æ–‡ä»¶éƒ½è¢«æ­£ç¡®å¤åˆ¶|
|**è·¯å¾„é”™è¯¯**|ä½¿ç”¨Â `os.path.abspath`Â å’ŒÂ `sys.path.insert`Â ç¡®ä¿è·¯å¾„æ­£ç¡®|
|**è®¸å¯è¯é—®é¢˜**|ç¡®ä¿ PyTorch å’Œå…¶ä¾èµ–çš„è®¸å¯è¯å…è®¸åˆ†å‘|
|**CUDA ä¾èµ–ç¼ºå¤±**|å¦‚æœä½¿ç”¨ CUDAï¼Œéœ€é¢å¤–å¤åˆ¶Â `cudnn64_8.dll`Â ç­‰ CUDA ç›¸å…³åº“|

### âœ… 6.Â **éªŒè¯æ‰“åŒ…ç»“æœ**

1. **æ£€æŸ¥æ‰“åŒ…åçš„ç›®å½•ç»“æ„**ï¼š
    
    - ç¡®ä¿Â `dist/main_window/`Â ç›®å½•ä¸‹åŒ…å«ï¼š
        - `torch/`Â ç›®å½•ï¼ˆæ‰‹åŠ¨è¿ç§»çš„ PyTorch æ¨¡å—ï¼‰
        - `torch.dll`ã€`torch_cpu.dll`Â ç­‰ DLL æ–‡ä»¶
2. **è¿è¡Œç¨‹åº**ï¼š
    
    
    ```bash
    dist/main_window/main_window.exe
    ```
    
      
    - ç¡®ä¿Â `import torch`Â ä¸æŠ¥é”™
    - éªŒè¯Â `torch.cuda.is_available()`Â æ˜¯å¦èƒ½æ­£ç¡®è¯†åˆ« GPUï¼ˆå¦‚æœä½¿ç”¨ CUDAï¼‰

### âœ… 7.Â **æ¨èæ“ä½œæ­¥éª¤**

1. **æ¸…ç†ç¼“å­˜**ï¼š
    
    
    ```bash
    rm -rf build dist
    ```
    
      
    
2. **æ‰“åŒ…æ—¶æ˜¾å¼æ·»åŠ  PyTorch ä¾èµ–**ï¼š
    
    
    ```bash
    pyinstaller --clean main_window.spec \
      --add-binary "venv\Lib\site-packages\torch\lib\torch.dll;." \
      --add-binary "venv\Lib\site-packages\torch\lib\torch_cpu.dll;."
    ```
    
      
    
3. **æ‰‹åŠ¨éªŒè¯ä¾èµ–**ï¼š
    
    - æ£€æŸ¥Â `dist/main_window/`Â ç›®å½•æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦çš„Â `.dll`Â å’ŒÂ `torch/`Â ç›®å½•
    - è¿è¡Œç¨‹åºï¼Œç¡®ä¿Â `torch`Â èƒ½è¢«æ­£ç¡®å¯¼å…¥

### âœ… 8.Â **æœ€ç»ˆå»ºè®®**

|åœºæ™¯|æ¨èæ–¹æ³•|
|---|---|
|**PyTorch æ‰“åŒ…å¤±è´¥**|æ‰‹åŠ¨è¿ç§»Â `torch/`Â ç›®å½•ï¼Œå¹¶æ˜¾å¼æ·»åŠ è·¯å¾„|
|**ä¾èµ– DLL ç¼ºå¤±**|æ‰‹åŠ¨å¤åˆ¶Â `torch/lib/`Â ä¸­çš„Â `.dll`Â æ–‡ä»¶|
|**è·¯å¾„é—®é¢˜**|ä½¿ç”¨Â `sys.path.insert`Â æ˜¾å¼æ·»åŠ è·¯å¾„|
|**è®¸å¯è¯é—®é¢˜**|ç¡®ä¿åˆ†å‘çš„åº“ç¬¦åˆè®¸å¯åè®®|

  

å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–æ‰“åŒ…ä½“ç§¯æˆ–ä¿®å¤ä¾èµ–é—®é¢˜ï¼Œè¯·æä¾›å®Œæ•´çš„Â `main_window.py`Â å’ŒÂ `requirements.txt`Â å†…å®¹ã€‚